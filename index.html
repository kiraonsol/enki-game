<!DOCTYPE html>
<html style="background-color: black;">
<head>
  <title>ENKI</title>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBlTVNMSh1hCjzLLu5SV4XJZRfyOZgLMVc",
      authDomain: "enki-game.firebaseapp.com",
      databaseURL: "https://enki-game-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "enki-game",
      storageBucket: "enki-game.firebasestorage.app",
      messagingSenderId: "902253472756",
      appId: "1:902253472756:web:eea22ee4ee0021ad2fe7a1"
    };

    let firebaseInitialized = false;
    let database = null;
    try {
      firebase.initializeApp(firebaseConfig);
      window.database = firebase.database();
      firebaseInitialized = true;
      window.firebaseReady = true;
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      window.firebaseReady = false;
      window.database = null;
      console.log('Firebase disabled for debugging');
    }

    // Initialize Telegram WebApp with retry and error handling
    function initializeTelegramWebApp() {
      return new Promise((resolve) => {
        let attempts = 20;
        const interval = setInterval(() => {
          if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            try {
              Telegram.WebApp.ready();
              Telegram.WebApp.expand();
              console.log('Telegram WebApp initialized successfully');
              clearInterval(interval);
              resolve(true);
            } catch (error) {
              console.error('Telegram WebApp initialization error:', error);
              clearInterval(interval);
              resolve(false);
            }
          } else if (attempts === 0) {
            console.warn('Telegram WebApp not available after retries');
            clearInterval(interval);
            resolve(false);
          }
          attempts--;
          console.log('Attempting to initialize Telegram WebApp, attempts remaining:', attempts);
        }, 500);
      });
    }

    // Call initialization on load with delay
    setTimeout(() => {
      initializeTelegramWebApp().then((success) => {
        if (!success) {
          console.error('Failed to initialize Telegram WebApp');
        }
      });
    }, 2000);
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
  <style>
    body { margin: 0; padding: 0; background-color: black; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script src="sketch.js"></script>
  <script>
    window.gameState = "start";
    window.playerScore = 0;
    window.playerName = "";
    window.nameInputVisible = false;

    async function showNameInput(score) {
      console.log('showNameInput called with score:', score);
      const isWebAppReady = await initializeTelegramWebApp();
      if (isWebAppReady) {
        let attempts = 5;
        while (attempts > 0) {
          try {
            Telegram.WebApp.ready();
            console.log('Attempting to show Telegram prompt, attempt:', 6 - attempts);
            let name = await new Promise(resolve => {
              Telegram.WebApp.showPopup({
                title: "Enter Your Name",
                message: `Score: ${score}\nEnter your name (max 10 chars):`,
                buttons: [{ type: "ok", id: "submit" }, { type: "cancel" }]
              }, (buttonId) => {
                console.log('Popup response:', buttonId);
                if (buttonId === "submit") {
                  Telegram.WebApp.showPrompt("Your name:", resolve);
                } else {
                  resolve("");
                }
              });
            });

            console.log('Received name from prompt:', name);
            name = (name || "").trim();
            if (name.length > 0) {
              if (name.length > 10) {
                name = name.substring(0, 10);
                Telegram.WebApp.showAlert("Name truncated to 10 characters.");
              }
              window.playerName = name;
              if (window.database) {
                await window.addToLeaderboard(window.playerName, score);
                console.log('Score saved:', { name: window.playerName, score });
                if (window.loadLeaderboard) await window.loadLeaderboard();
              } else {
                console.log('Firebase not available, skipping score save');
              }
              break;
            } else {
              Telegram.WebApp.showAlert("No name entered. Score not saved.");
              break;
            }
          } catch (error) {
            console.error('Error using Telegram WebApp, attempt:', 6 - attempts, error);
            attempts--;
            if (attempts === 0) {
              console.error('All attempts failed, falling back to default prompt');
              Telegram.WebApp.showAlert("Error saving score. Falling back to default prompt.");
              let fallbackName = prompt("Enter your name (max 10 chars):", "");
              fallbackName = (fallbackName || "").trim();
              if (fallbackName.length > 0) {
                if (fallbackName.length > 10) fallbackName = fallbackName.substring(0, 10);
                window.playerName = fallbackName;
                if (window.database) {
                  await window.addToLeaderboard(window.playerName, score);
                  if (window.loadLeaderboard) await window.loadLeaderboard();
                }
              }
            }
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      } else {
        console.error('Telegram WebApp not available');
        let name = prompt("Enter your name (max 10 chars):", "");
        name = (name || "").trim();
        if (name.length > 0) {
          if (name.length > 10) name = name.substring(0, 10);
          window.playerName = name;
          if (window.database) {
            await window.addToLeaderboard(window.playerName, score);
            if (window.loadLeaderboard) await window.loadLeaderboard();
          }
        }
      }
      window.gameState = "nameInput";
      window.nameInputVisible = true;
      setTimeout(() => {
        window.gameState = "gameover";
        window.nameInputVisible = false;
        console.log('Name input completed, returning to game over state');
      }, 2000);
    }

    window.showNameInput = showNameInput;
  </script>
</body>
</html>
