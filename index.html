<!DOCTYPE html>
<html style="background-color: black;">
<head>
  <title>ENKI</title>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBlTVNMSh1hCjzLLu5SV4XJZRfyOZgLMVc",
      authDomain: "enki-game.firebaseapp.com",
      databaseURL: "https://enki-game-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "enki-game",
      storageBucket: "enki-game.firebasestorage.app",
      messagingSenderId: "902253472756",
      appId: "1:902253472756:web:eea22ee4ee0021ad2fe7a1"
    };

    let firebaseInitialized = false;
    try {
      firebase.initializeApp(firebaseConfig);
      window.database = firebase.database();
      firebaseInitialized = true;
      window.firebaseReady = true;
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      window.firebaseReady = false;
      window.database = null;
      console.log('Firebase disabled for debugging');
    }

    // Telegram WebApp initialization status
    let isWebAppReady = false;

    // Initialize Telegram WebApp with retry and error handling
    function initializeTelegramWebApp() {
      return new Promise((resolve) => {
        let attempts = 200; // Retry for up to 100 seconds
        console.log('Starting Telegram WebApp initialization...');
        console.log('Window object:', window);
        const interval = setInterval(() => {
          if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            try {
              Telegram.WebApp.ready();
              Telegram.WebApp.expand();
              console.log('Telegram WebApp initialized successfully');
              console.log('Telegram WebApp details:', Telegram.WebApp);
              console.log('Init Data:', Telegram.WebApp.initData);
              console.log('User:', Telegram.WebApp.initDataUnsafe?.user);
              console.log('Platform:', Telegram.WebApp.platform);
              console.log('Version:', Telegram.WebApp.version);
              isWebAppReady = true;
              clearInterval(interval);
              resolve(true);
            } catch (error) {
              console.error('Telegram WebApp initialization error:', error);
              clearInterval(interval);
              resolve(false);
            }
          } else if (attempts === 0) {
            console.warn('Telegram WebApp not available after retries');
            console.log('Global window.Telegram:', window.Telegram);
            clearInterval(interval);
            resolve(false);
          }
          attempts--;
          console.log('Attempting to initialize Telegram WebApp, attempts remaining:', attempts);
        }, 500);
      });
    }

    // Call initialization on load with initial delay
    setTimeout(async () => {
      const success = await initializeTelegramWebApp();
      if (!success) {
        console.error('Failed to initialize Telegram WebApp after all retries');
      }
    }, 5000);

    // Re-attempt initialization dynamically
    async function ensureWebAppReady() {
      if (!isWebAppReady) {
        console.log('WebApp not ready, re-attempting initialization...');
        return await initializeTelegramWebApp();
      }
      return true;
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
  <style>
    body { margin: 0; padding: 0; background-color: black; overflow: hidden; }
    canvas { display: block; }
    #leaderboard {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 16px;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="leaderboard"></div>
  <script src="sketch.js"></script>
  <script>
    window.gameState = "loading"; // Start in a loading state
    window.playerScore = 0;
    window.playerName = "";
    window.nameInputVisible = false;
    window.leaderboardData = [];

    // Start the game after a delay, with a timeout to prevent infinite loading
    const maxLoadingTime = 120000; // 120 seconds max loading time
    setTimeout(() => {
      if (window.gameState === "loading") {
        console.error('Loading timed out after 120 seconds, proceeding to start state');
        window.gameState = "start";
      }
    }, maxLoadingTime);

    setTimeout(() => {
      if (isWebAppReady) {
        window.gameState = "start";
        console.log('Game state set to start');
      } else {
        console.error('Cannot start game: Telegram WebApp not initialized, waiting for timeout');
      }
    }, 6000);

    // Load leaderboard data from Firebase
    async function loadLeaderboard() {
      if (!window.database) {
        console.error('Firebase database not available');
        return;
      }
      try {
        const snapshot = await window.database.ref('leaderboard').orderByChild('score').limitToLast(10).once('value');
        const leaderboard = [];
        snapshot.forEach(child => {
          const entry = child.val();
          leaderboard.push({ name: entry.name, score: entry.score });
        });
        // Sort in descending order (highest score first)
        leaderboard.sort((a, b) => b.score - a.score);
        window.leaderboardData = leaderboard;
        console.log('Leaderboard loaded:', window.leaderboardData);
        updateLeaderboardDisplay();
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    // Update leaderboard display
    function updateLeaderboardDisplay() {
      const leaderboardDiv = document.getElementById('leaderboard');
      if (window.gameState === "leaderboard") {
        let html = "<b>Leaderboard (Top 10)</b><br>";
        window.leaderboardData.forEach((entry, index) => {
          html += `${index + 1}. ${entry.name}: ${entry.score}<br>`;
        });
        leaderboardDiv.innerHTML = html;
        leaderboardDiv.style.display = 'block';
      } else {
        leaderboardDiv.style.display = 'none';
      }
    }

    // Add score to Firebase leaderboard
    async function addToLeaderboard(name, score) {
      if (!window.database) {
        console.error('Firebase database not available');
        return;
      }
      try {
        await window.database.ref('leaderboard').push({ name, score });
        console.log('Score added to leaderboard:', { name, score });
      } catch (error) {
        console.error('Error adding score to leaderboard:', error);
      }
    }

    // Show name input prompt
    async function showNameInput(score) {
      console.log('showNameInput called with score:', score);
      let name = "";
      
      // Ensure WebApp is ready
      const webAppSuccess = await ensureWebAppReady();
      if (webAppSuccess) {
        let attempts = 5;
        while (attempts > 0) {
          try {
            Telegram.WebApp.ready();
            console.log('Attempting to show Telegram prompt, attempt:', 6 - attempts);
            name = await new Promise(resolve => {
              Telegram.WebApp.showPopup({
                title: "Enter Your Name",
                message: `Score: ${score}\nEnter your name (max 10 chars):`,
                buttons: [{ type: "ok", id: "submit" }, { type: "cancel" }]
              }, (buttonId) => {
                console.log('Popup response:', buttonId);
                if (buttonId === "submit") {
                  Telegram.WebApp.showPrompt("Your name:", resolve);
                } else {
                  resolve("");
                }
              });
            });

            console.log('Received name from prompt:', name);
            break;
          } catch (error) {
            console.error('Error using Telegram WebApp, attempt:', 6 - attempts, error);
            attempts--;
            if (attempts === 0) {
              console.error('All attempts failed, falling back to browser prompt');
              name = prompt("Enter your name (max 10 chars):", "");
              if (!name) {
                alert("No name entered. Score not saved.");
                window.gameState = "gameover";
                window.nameInputVisible = false;
                return;
              }
            }
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      } else {
        console.error('Telegram WebApp not available after all retries');
        // Fallback to browser prompt
        name = prompt("Enter your name (max 10 chars):", "");
        if (!name) {
          alert("No name entered. Score not saved.");
          window.gameState = "gameover";
          window.nameInputVisible = false;
          return;
        }
      }

      name = (name || "").trim();
      if (name.length > 0) {
        if (name.length > 10) {
          name = name.substring(0, 10);
          if (isWebAppReady) {
            Telegram.WebApp.showAlert("Name truncated to 10 characters.");
          } else {
            alert("Name truncated to 10 characters.");
          }
        }
        window.playerName = name;
        if (window.database) {
          await window.addToLeaderboard(window.playerName, score);
          console.log('Score saved:', { name: window.playerName, score });
          await loadLeaderboard();
        } else {
          console.log('Firebase not available, skipping score save');
        }
      } else {
        if (isWebAppReady) {
          Telegram.WebApp.showAlert("No name entered. Score not saved.");
        } else {
          alert("No name entered. Score not saved.");
        }
      }

      window.gameState = "nameInput";
      window.nameInputVisible = true;
      setTimeout(() => {
        window.gameState = "leaderboard";
        window.nameInputVisible = false;
        console.log('Transitioning to leaderboard state');
      }, 2000);
    }

    window.showNameInput = showNameInput;
    window.loadLeaderboard = loadLeaderboard;
  </script>
</body>
</html>
