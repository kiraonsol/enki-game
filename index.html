<!DOCTYPE html>
<html style="background-color: black;">
<head>
  <title>ENKI</title>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-database-compat.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBlTVNMSh1hCjzLLu5SV4XJZRfyOZgLMVc",
      authDomain: "enki-game.firebaseapp.com",
      databaseURL: "https://enki-game-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "enki-game",
      storageBucket: "enki-game.firebasestorage.app",
      messagingSenderId: "902253472756",
      appId: "1:902253472756:web:eea22ee4ee0021ad2fe7a1"
    };

    // Initialize Firebase
    let firebaseInitialized = false;
    try {
      firebase.initializeApp(firebaseConfig);
      window.database = firebase.database();
      firebaseInitialized = true;
      window.firebaseReady = true;
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      window.firebaseReady = false;
      window.database = null;
      alert('Failed to initialize Firebase. Leaderboard may not work.');
    }

    // Initialize Telegram WebApp
    if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand(); // Maximize the web app height within Telegram
      console.log('Telegram WebApp initialized and expanded');
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
  <style>
    body { margin: 0; padding: 0; background-color: black; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script src="sketch.js"></script>
  <script>
    // Global game state variables
    window.gameState = "start";
    window.playerScore = 0;
    window.playerName = "";
    window.nameInputVisible = false;

    // Show name input for leaderboard using Telegram WebApp
    async function showNameInput(score) {
      console.log('showNameInput called with score:', score);
      if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
        try {
          Telegram.WebApp.ready();
          // Get user data from Telegram
          let user = Telegram.WebApp.initDataUnsafe.user || {};
          let suggestedName = user.username || user.first_name || "Player";

          // Show popup with score and suggested name
          let name = await new Promise(resolve => {
            Telegram.WebApp.showPopup({
              title: "Enter Your Name",
              message: `Score: ${score}\nEnter your name (leave blank for "${suggestedName}", max 10 chars):`,
              buttons: [{ type: "ok", id: "submit" }, { type: "cancel" }]
            }, (buttonId) => {
              if (buttonId === "submit") {
                Telegram.WebApp.showPrompt("Your name:", (input) => {
                  resolve(input || "");
                });
              } else {
                resolve("");
              }
            });
          });

          name = (name || "").trim();
          if (name === "") {
            name = suggestedName; // Use Telegram name if input is empty
          }
          if (name.length > 10) {
            name = name.substring(0, 10);
            Telegram.WebApp.showAlert("Name truncated to 10 characters.");
          }
          if (name) {
            window.playerName = name;
            await window.addToLeaderboard(window.playerName, score);
            console.log('Score saved:', { name: window.playerName, score });
            if (window.loadLeaderboard) await window.loadLeaderboard();
          } else {
            Telegram.WebApp.showAlert("No name provided. Score not saved.");
          }
        } catch (error) {
          console.error('Error using Telegram WebApp:', error);
          Telegram.WebApp.showAlert("Error saving score. Please try again.");
        }
      } else {
        console.error('Telegram WebApp not available');
        alert('Name input requires Telegram. Play via the bot.');
      }
      window.gameState = "nameInput";
      window.nameInputVisible = true;
      setTimeout(() => {
        window.gameState = "gameover";
        window.nameInputVisible = false;
      }, 2000);
    }

    // Expose showNameInput to the global scope for sketch.js
    window.showNameInput = showNameInput;
  </script>
</body>
</html>
