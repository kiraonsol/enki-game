<!DOCTYPE html>
<html style="background-color: black;">
<head>
  <title>ENKI</title>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBlTVNMSh1hCjzLLu5SV4XJZRfyOZgLMVc",
      authDomain: "enki-game.firebaseapp.com",
      databaseURL: "https://enki-game-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "enki-game",
      storageBucket: "enki-game.firebasestorage.app",
      messagingSenderId: "902253472756",
      appId: "1:902253472756:web:eea22ee4ee0021ad2fe7a1"
    };

    let firebaseInitialized = false;
    try {
      firebase.initializeApp(firebaseConfig);
      window.database = firebase.database();
      firebaseInitialized = true;
      window.firebaseReady = true;
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      window.firebaseReady = false;
      window.database = null;
      console.log('Firebase disabled for debugging');
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
  <style>
    body { margin: 0; padding: 0; background-color: black; overflow: hidden; }
    canvas { display: block; }
    #leaderboard {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 16px;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="leaderboard"></div>
  <script src="sketch.js"></script>
  <script>
    window.gameState = "loading"; // Start in a loading state
    window.playerScore = 0;
    window.playerName = "";
    window.nameInputVisible = false;
    window.leaderboardData = [];

    // Start the game after a short delay
    setTimeout(() => {
      window.gameState = "start";
      console.log('Game state set to start');
    }, 3000); // 3-second delay to show loading message

    // Load leaderboard data from Firebase
    async function loadLeaderboard() {
      if (!window.database) {
        console.error('Firebase database not available');
        return;
      }
      try {
        const snapshot = await window.database.ref('leaderboard').orderByChild('score').limitToLast(10).once('value');
        const leaderboard = [];
        snapshot.forEach(child => {
          const entry = child.val();
          leaderboard.push({ name: entry.name, score: entry.score });
        });
        // Sort in descending order (highest score first)
        leaderboard.sort((a, b) => b.score - a.score);
        window.leaderboardData = leaderboard;
        console.log('Leaderboard loaded:', window.leaderboardData);
        updateLeaderboardDisplay();
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    // Update leaderboard display
    function updateLeaderboardDisplay() {
      const leaderboardDiv = document.getElementById('leaderboard');
      if (window.gameState === "leaderboard") {
        let html = "<b>Leaderboard (Top 10)</b><br>";
        window.leaderboardData.forEach((entry, index) => {
          html += `${index + 1}. ${entry.name}: ${entry.score}<br>`;
        });
        leaderboardDiv.innerHTML = html;
        leaderboardDiv.style.display = 'block';
      } else {
        leaderboardDiv.style.display = 'none';
      }
    }

    // Show name input prompt (always send to bot)
    async function showNameInput(score) {
      console.log('showNameInput called with score:', score);
      if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
        try {
          Telegram.WebApp.sendData(JSON.stringify({ action: "submit_score", score: score }));
          console.log('Sent score to bot via sendData:', score);
        } catch (error) {
          console.error('Error sending data to bot:', error);
          alert('Failed to send score to bot. Please try again.');
        }
      } else {
        console.error('Telegram WebApp not available for sendData');
        alert('Score submission requires Telegram. Play via the bot.');
      }

      window.gameState = "nameInput";
      window.nameInputVisible = true;
      setTimeout(() => {
        window.gameState = "leaderboard";
        window.nameInputVisible = false;
        console.log('Transitioning to leaderboard state');
      }, 2000);
    }

    window.showNameInput = showNameInput;
    window.loadLeaderboard = loadLeaderboard;
  </script>
</body>
</html>
